// EduTrack Hub - Schema for Neon (Serverless PostgreSQL)
// Phase 1 Complete: Real data, progress tracking, attendance, audit trail

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER MODEL - ADMIN and STUDENT roles
// ============================================================================

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  name          String
  password      String     // bcrypt hashed
  role          UserRole   @default(STUDENT)
  phone         String?
  isActive      Boolean    @default(true)
  emailVerified Boolean    @default(false)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  enrollments   Enrollment[]
  payments      Payment[]
  progress      Progress[]
  auditLogs     AuditLog[]   @relation("AuditActor")

  @@index([email])
  @@index([role])
}

enum UserRole {
  ADMIN
  STUDENT
}

// ============================================================================
// CLASS MODEL - Live tutoring sessions
// ============================================================================

model Class {
  id            String      @id @default(cuid())
  title         String
  description   String?
  subject       String      // e.g., "IGCSE Math", "SAT Reading"
  level         ClassLevel  @default(BEGINNER)
  
  // Scheduling
  scheduledTime DateTime
  duration      Int         // in minutes
  timezone      String      @default("Africa/Lagos")
  
  // Capacity
  maxStudents   Int         @default(10)
  
  // Pricing (in smallest currency unit, e.g., kobo for NGN)
  price         Int         @default(0) // 0 = free
  currency      String      @default("NGN")
  
  // Meeting
  meetUrl       String?     // Google Meet link
  meetingId     String?     // For tracking
  
  // Post-class artifacts
  recordingUrl  String?     // Link to recording after class
  notesUrl      String?     // Link to class notes/summary
  
  // Status
  status        ClassStatus @default(SCHEDULED)
  
  // Metadata
  topics        String?     // JSON array stored as text
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  enrollments   Enrollment[]
  attendance    Attendance[]

  @@index([subject])
  @@index([level])
  @@index([scheduledTime])
  @@index([status])
}

enum ClassLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ClassStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

// ============================================================================
// ENROLLMENT MODEL - Student enrolled in a class
// ============================================================================

model Enrollment {
  id            String           @id @default(cuid())
  
  // Relations
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  class         Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  classId       String
  
  // Status
  status        EnrollmentStatus @default(PENDING)
  
  // Tracking
  enrolledAt    DateTime         @default(now())
  confirmedAt   DateTime?        // When payment confirmed or free class enrolled
  completedAt   DateTime?        // When class completed
  
  // Payment reference
  paymentId     String?          // Links to Payment if paid class

  // Feedback (post-class)
  rating        Int?             // 1-5 stars
  feedback      String?          // Written feedback

  @@unique([userId, classId])
  @@index([userId])
  @@index([classId])
  @@index([status])
}

enum EnrollmentStatus {
  PENDING    // Awaiting payment or confirmation
  CONFIRMED  // Payment received, can attend
  ATTENDED   // Actually attended the class
  COMPLETED  // Attended + marked complete
  MISSED     // Didn't show up
  CANCELLED  // Student cancelled
  REFUNDED   // Payment refunded
}

// ============================================================================
// ATTENDANCE MODEL - Track actual class attendance
// ============================================================================

model Attendance {
  id          String   @id @default(cuid())
  
  // Relations
  classId     String
  class       Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  userId      String
  
  // Timing
  joinedAt    DateTime @default(now())
  leftAt      DateTime?
  duration    Int?     // Minutes attended (calculated on leave)
  
  // Status
  wasPresent  Boolean  @default(true)
  
  @@unique([classId, userId])
  @@index([classId])
  @@index([userId])
}

// ============================================================================
// PROGRESS MODEL - Track learning progress per student
// ============================================================================

model Progress {
  id              String   @id @default(cuid())
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String
  
  // Subject-level progress
  subject         String   // e.g., "IGCSE Math", "SAT Reading"
  
  // Metrics
  classesEnrolled Int      @default(0)
  classesAttended Int      @default(0)
  classesCompleted Int     @default(0)
  totalMinutes    Int      @default(0) // Total learning time
  
  // Level tracking
  currentLevel    ClassLevel @default(BEGINNER)
  
  // Achievements
  lastClassDate   DateTime?
  streak          Int      @default(0) // Consecutive classes attended
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, subject])
  @@index([userId])
  @@index([subject])
}

// ============================================================================
// PAYMENT MODEL - Track payments via Stripe
// ============================================================================

model Payment {
  id              String        @id @default(cuid())
  
  // User
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String
  
  // Amount
  amount          Int           // In smallest unit (kobo/cents)
  currency        String        @default("NGN")
  
  // Stripe
  stripePaymentId String?       @unique // Stripe PaymentIntent ID
  stripeSessionId String?       // Stripe Checkout Session ID
  
  // Status
  status          PaymentStatus @default(PENDING)
  
  // What they paid for
  classId         String?       // If paying for a specific class
  description     String?
  
  // Timestamps
  createdAt       DateTime      @default(now())
  paidAt          DateTime?
  refundedAt      DateTime?

  @@index([userId])
  @@index([stripePaymentId])
  @@index([status])
  @@index([createdAt])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ============================================================================
// CONTACT MESSAGE - Contact form submissions
// ============================================================================

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String?
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([isRead])
  @@index([createdAt])
}

// ============================================================================
// RESOURCE - Free downloadable content
// ============================================================================

model Resource {
  id          String       @id @default(cuid())
  title       String
  description String?
  type        ResourceType
  subject     String
  level       ClassLevel   @default(BEGINNER)
  url         String       // Link to PDF, video, etc.
  isPublished Boolean      @default(false)
  downloads   Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([type])
  @@index([subject])
  @@index([isPublished])
}

enum ResourceType {
  VIDEO
  PDF
  WORKSHEET
  ARTICLE
  GAME
}

// ============================================================================
// AUDIT LOG - Track admin actions for accountability
// ============================================================================

model AuditLog {
  id          String   @id @default(cuid())
  
  // Who
  actor       User     @relation("AuditActor", fields: [actorId], references: [id], onDelete: Cascade)
  actorId     String
  
  // What
  action      String   // CREATE, UPDATE, DELETE, etc.
  entity      String   // User, Class, Enrollment, etc.
  entityId    String   // ID of affected entity
  
  // Details
  changes     String?  // JSON diff of changes
  metadata    String?  // Additional context
  
  // When
  createdAt   DateTime @default(now())

  @@index([actorId])
  @@index([entity])
  @@index([action])
  @@index([createdAt])
}
